# ADR-0004: Платежи: внешний провайдер + вебхуки + идемпотентность

- Статус: Accepted
- Дата: 2025-12-25
- Контекст проекта: Платформа для краудфандинга (авторы проектов, бэкеры/спонсоры, администраторы, потенциальные инвесторы)


## Контекст
Сбор средств — критическая часть. Нужна безопасность транзакций, защита от дублей платежей, обработка возвратов и спорных ситуаций.

## Решение
- Интеграция с **платежным провайдером** (Stripe/Adyen/CloudPayments/ЮKassa и т.п. — зависит от региона) через:
  - создание платежного намерения/инвойса на стороне backend,
  - подтверждение на стороне провайдера,
  - прием **webhook**-событий (paid/failed/refunded/chargeback).
- **Идемпотентность**:
  - каждый платеж имеет `payment_intent_id` (провайдер) и `idempotency_key` (наша сторона),
  - вебхуки обрабатываются ровно-один-раз (таблица полученных событий + unique constraint).
- **Состояния** платежа: CREATED → PENDING → SUCCEEDED/FAILED → REFUNDED/CHARGEBACK.
- Храним у себя только безопасные данные (tokenized), **не** храним PAN/полные карты.

## Обоснование
- **Регуляторика и риски**: самостоятельная обработка карт требует PCI DSS и резко увеличивает стоимость/риски — провайдер снимает это.
- **Надежность состояния платежа**: вебхуки — источник истины о факте оплаты/возврата; polling ухудшает UX и повышает шанс рассинхронизации.
- **Защита от дублей**: идемпотентность критична из‑за повторов запросов (сетевые сбои, повторная отправка вебхуков).

## Альтернативы
1) Собственная платежная обработка  
   − практически всегда запрещено/невыгодно из‑за PCI DSS и рисков.

2) Платежи без вебхуков (только polling)  
   − хуже надежность и UX, выше нагрузка и риски расхождения статусов.

## Последствия
+ Соответствие требованиям безопасности и устойчивости.  
+ Устойчивость к повторам запросов и дублям вебхуков.  
− Требуется надежный публичный endpoint для webhook и мониторинг (алерты на задержки/ошибки).
